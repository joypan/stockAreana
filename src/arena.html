<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analyst Arena | è‚¡ç¥¨åˆ†æå¸«ç«¶æŠ€å ´</title>
    
    <!-- PrimeFlex -->
    <link rel="stylesheet" href="https://unpkg.com/primeflex@3.3.1/primeflex.css">
  
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Marked for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --blue-100: #dbeafe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-900: #1e3a8a;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --surface-100: #f3f4f6;
            --surface-200: #e5e7eb;
            --surface-border: #dfe7ef;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .monitor-card {
            background: #1e1e1e;
            color: #00ff41;
            font-family: 'Consolas', monospace;
            border-radius: 8px;
            padding: 1rem;
            height: 500px; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto; /* å…è¨±æ»¾å‹• */
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .response-card {
            height: 500px; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto; /* å…è¨±æ»¾å‹• */
        }
        .analyst-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stream-content {
            white-space: normal;
            line-height: 1.5;
            word-break: break-word;
        }
        /* Markdown ç·Šæ¹Šæ¨¡å¼ */
        .stream-content p {
            margin: 0 0 0.4em 0;
        }
        .stream-content h1,
        .stream-content h2,
        .stream-content h3,
        .stream-content h4,
        .stream-content h5,
        .stream-content h6 {
            margin: 0.5em 0 0.2em 0;
        }
        .stream-content ul,
        .stream-content ol {
            margin: 0 0 0.4em 0;
            padding-left: 1.5em;
        }
        /* åµŒå¥—åˆ—è¡¨ - æ›´ç·Šæ¹Š */
        .stream-content ul ul,
        .stream-content ul ol,
        .stream-content ol ul,
        .stream-content ol ol {
            margin: 0;
        }
        .stream-content li {
            margin: 0.15em 0;
        }
        /* æ¸…é™¤é¦–å°¾ç©ºç™½ */
        .stream-content > *:first-child {
            margin-top: 0;
        }
        .stream-content > *:last-child {
            margin-bottom: 0;
        }
        .stream-content blockquote {
            margin: 0.3em 0;
            padding: 0.2em 0.5em;
            border-left: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .stream-content pre {
            margin: 0.3em 0;
            padding: 0.4em;
  
            border-radius: 4px;
            overflow-x: auto;
        }
        .stream-content code {
            font-size: 0.9em;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        @media print {
            .stream-content p, 
            .stream-content h1, 
            .stream-content h2, 
            .stream-content h3, 
            .stream-content h4, 
            .stream-content h5, 
            .stream-content h6, 
            .stream-content li, 
            .stream-content blockquote, 
            .stream-content pre {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-column">
    
    <!-- Navbar -->
    <div class="surface-0 shadow-2 p-3 flex justify-content-between align-items-center z-5">
        <div class="flex align-items-center gap-3">
            <i class="fa-solid fa-chart-line text-3xl text-primary"></i>
            <div>
                <h1 class="m-0 text-xl font-bold text-900">Stock Analyst Arena</h1>
                <span class="text-sm text-500">AI è‚¡ç¥¨åˆ†æå¸«ç«¶æŠ€å ´</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button @click="currentView = 'ARENA'" :class="['p-2 px-3 border-round border-none cursor-pointer transition-all transition-duration-200 font-medium', currentView === 'ARENA' ? 'bg-primary  shadow-2' : 'surface-200 text-600 hover:surface-300']" :style="currentView !== 'ARENA' ? 'backdrop-filter: blur(8px); opacity: 0.85;' : ''">
                <i class="fa-solid fa-gavel mr-2"></i>ç«¶æŠ€å ´
            </button>
            <button @click="currentView = 'HISTORY'" :class="['p-2 px-3 border-round border-none cursor-pointer transition-all transition-duration-200 font-medium', currentView === 'HISTORY' ? 'bg-primary  shadow-2' : 'surface-200 text-600 hover:surface-300']" :style="currentView !== 'HISTORY' ? 'backdrop-filter: blur(8px); opacity: 0.85;' : ''">
                <i class="fa-solid fa-clock-rotate-left mr-2"></i>æ­·å²ç´€éŒ„
            </button>
            <button @click="currentView = 'ANALYSTS'" :class="['p-2 px-3 border-round border-none cursor-pointer transition-all transition-duration-200 font-medium', currentView === 'ANALYSTS' ? 'bg-primary  shadow-2' : 'surface-200 text-600 hover:surface-300']" :style="currentView !== 'ANALYSTS' ? 'backdrop-filter: blur(8px); opacity: 0.85;' : ''">
                <i class="fa-solid fa-users mr-2"></i>åˆ†æå¸«ç®¡ç†
            </button>
            <a href="https://github.com/joypan/stockAreana" target="_blank" class="border-circle surface-100 border-none cursor-pointer hover:surface-200 text-700 w-3rem h-3rem flex align-items-center justify-content-center no-underline transition-colors" title="GitHub Repo">
                <i class="fa-brands fa-github text-lg"></i>
            </a>
            <button @click="showSettings = true" class="p-0 border-circle surface-100 border-none cursor-pointer hover:surface-200 text-700 w-3rem h-3rem flex align-items-center justify-content-center">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 p-4 overflow-y-auto">
        
        <!-- View: Analyst Management -->
        <div v-if="currentView === 'ANALYSTS'" class="max-w-60rem mx-auto fadein animation-duration-300">
            <div class="flex justify-content-between align-items-center mb-4">
                <h2 class="text-2xl font-bold m-0">åˆ†æå¸«åœ˜éšŠ</h2>
                <button @click="openAnalystModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" class="text-white border-none p-3 px-4 border-round cursor-pointer font-bold shadow-4 hover:shadow-6 transition-all transition-duration-200 text-lg">
                    <i class="fa-solid fa-plus mr-2"></i>æ–°å¢åˆ†æå¸«
                </button>
            </div>

            <div v-if="analysts.length === 0" class="surface-card p-6 border-round shadow-1 text-center">
                <i class="fa-solid fa-robot text-6xl text-300 mb-3"></i>
                <p class="text-xl text-500">ç›®å‰æ²’æœ‰ä»»ä½•åˆ†æå¸«ï¼Œè«‹å…ˆå»ºç«‹æ‚¨çš„ AI åœ˜éšŠã€‚</p>
            </div>

            <div class="grid">
                <div v-for="analyst in analysts" :key="analyst.id" class="col-12 md:col-6 lg:col-4">
                    <div class="surface-card p-4 shadow-2 border-round h-full flex flex-column relative hover:shadow-4 transition-all transition-duration-300">
                        <div class="flex align-items-center mb-3">
                            <div class="analyst-avatar surface-200 flex align-items-center justify-content-center text-2xl mr-3">
                                {{ analyst.avatar || 'ğŸ¤–' }}
                            </div>
                            <div>
                                <h3 class="m-0 text-xl">{{ analyst.name }}</h3>
                                <span class="text-sm text-500 bg-blue-50 px-2 py-1 border-round mt-1 inline-block">{{ analyst.model }}</span>
                            </div>
                        </div>
                        <div class="flex-grow-1 text-600 mb-3 line-height-3 text-sm overflow-hidden" style="max-height: 6rem;">
                            {{ analyst.systemPrompt }}
                        </div>
                        <div class="flex justify-content-end gap-2 mt-auto">
                            <button @click="openAnalystModal(analyst)" class="p-2 border-circle surface-100 text-600 border-none cursor-pointer hover:bg-blue-100 hover:text-blue-600 transition-colors">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button type="button" @click="deleteAnalyst(analyst.id)" class="p-2 border-circle surface-100 text-600 border-none cursor-pointer hover:bg-red-100 hover:text-red-600 transition-colors" title="åˆªé™¤åˆ†æå¸«">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Arena -->
        <div v-if="currentView === 'ARENA'" class="max-w-70rem mx-auto fadein animation-duration-300">
            
            <!-- Setup Phase -->
            <div v-if="arenaState.status === 'IDLE'" class="surface-card p-5 shadow-2 border-round">
                <h2 class="text-2xl font-bold mb-4 border-bottom-1 surface-border pb-3">
                    <i class="fa-solid fa-flag-checkered mr-2 text-primary"></i>ç™¼èµ·ç«¶æŠ€
                </h2>
                
                <div class="field mb-5">
                    <label class="block text-900 font-medium mb-2">ç«¶æŠ€ä¸»é¡Œ (Theme)</label>
                    
                    <!-- Theme Selector -->
                    <div class="flex gap-2 mb-2" v-if="savedThemes.length > 0">
                         <select v-model="selectedThemeId" class="w-full p-2 border-1 border-300 border-round bg-white text-700">
                            <option :value="null">-- é¸æ“‡å¸¸ç”¨ä¸»é¡Œ / æˆ–è¼¸å…¥æ–°ä¸»é¡Œ --</option>
                            <option v-for="t in savedThemes" :key="t.id" :value="t.id">{{ t.content }}</option>
                        </select>
                        <button v-if="selectedThemeId" @click="deleteTheme($event, selectedThemeId)" class="p-2 bg-red-100 text-red-600 border-none border-round cursor-pointer hover:bg-red-200" title="åˆªé™¤æ­¤ä¸»é¡Œ">
                             <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>

                    <div class="p-inputgroup flex">
                        <input v-model="arenaState.theme" type="text" class="w-full p-3 border-1 border-300 border-round-left text-lg focus:border-primary focus:outline-none" placeholder="ä¾‹å¦‚ï¼šå°ç©é›» 2024 Q3 æ³•èªªæœƒè§€é»åˆ†æ...">
                        <button @click="saveCurrentTheme" class="bg-surface-100 text-700 border-1 border-300 border-round-right px-3 cursor-pointer hover:bg-surface-200" title="å„²å­˜ç‚ºå¸¸ç”¨ä¸»é¡Œ">
                             <i class="fa-solid fa-bookmark mr-1"></i>å„²å­˜
                        </button>
                    </div>
                </div>

                <div class="field mb-5">
                    <label class="block text-900 font-medium mb-2">åƒè³½åˆ†æå¸« (é¸æ“‡ 1 ~ 3 ä½)</label>
                    <div v-if="analysts.length === 0" class="text-orange-500">
                        <i class="fa-solid fa-exclamation-triangle mr-1"></i> è«‹å…ˆè‡³ã€Œåˆ†æå¸«ç®¡ç†ã€å»ºç«‹åˆ†æå¸«ã€‚
                    </div>
                    <div class="grid mt-2">
                        <div v-for="analyst in analysts" :key="analyst.id" class="col-12 md:col-4">
                            <div 
                                :class="['p-3 border-2 border-round cursor-pointer transition-options h-full flex flex-column', 
                                    arenaState.selectedAnalystIds.includes(analyst.id) ? 'border-primary surface-50' : 'border-200 surface-card opacity-70 hover:opacity-100']"
                                @click="toggleAnalystSelection(analyst.id)">
                                <div class="flex align-items-center gap-3 mb-2">
                                    <div class="text-2xl">{{ analyst.avatar || 'ğŸ¤–' }}</div>
                                    <div class="font-bold flex-grow-1">{{ analyst.name }}</div>
                                    <i v-if="arenaState.selectedAnalystIds.includes(analyst.id)" class="fa-solid fa-check-circle text-primary text-xl"></i>
                                </div>
                                <div v-if="arenaState.selectedAnalystIds.includes(analyst.id)" class="mt-auto" @click.stop>
                                    <label class="block text-xs text-500 mb-1">ä½¿ç”¨æ¨¡å‹ï¼š</label>
                                    <select v-model="arenaState.selectedModels[analyst.id]" class="w-full p-1 text-sm border-1 border-300 border-round bg-white">
                                        <option v-for="model in availableModels" :key="model" :value="model">{{ model }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field mb-5">
                     <label class="block text-900 font-medium mb-2">è£åˆ¤æ¨¡å‹ (Judge Model)</label>
                     <select v-model="arenaState.judgeModel" class="w-full p-3 border-1 border-300 border-round text-lg focus:border-primary focus:outline-none bg-white">
                         <option v-for="model in availableModels" :key="model" :value="model">{{ model }}</option>
                     </select>
                </div>

                <button 
                    @click="startArena" 
                    :disabled="!canStartArena"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" 
                    class="w-full font-bold text-white border-none p-3 text-xl border-round cursor-pointer shadow-3 hover:shadow-5 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <i class="fa-solid fa-play mr-2"></i>é–‹å§‹ç«¶æŠ€
                </button>
            </div>

            <!-- Active Phase -->
            <div v-else class="flex flex-column gap-4">
                
                <!-- Header -->
                <div class="surface-card p-3 shadow-1 border-round flex justify-content-between align-items-center">
                    <div>
                        <span class="text-500 text-sm">ç•¶å‰ä¸»é¡Œ</span>
                        <h2 class="m-0 text-primary text-xl">{{ arenaState.theme }}</h2>
                    </div>
                    <div>
                        <button @click="resetArena" class="p-2 px-3 surface-100 text-700 border-none border-round cursor-pointer hover:bg-red-50 hover:text-red-600 font-medium">
                            <i class="fa-solid fa-rotate-left mr-2"></i>é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- Round 1: Independent Views -->
                <div class="w-full">
                    <div class="flex align-items-center mb-3">
                        <div class="bg-blue-600 text-white w-2rem h-2rem border-circle flex align-items-center justify-content-center font-bold mr-2">1</div>
                        <h3 class="m-0 text-xl">ç¬¬ä¸€è¼ªï¼šç¨ç«‹è§€é» (Initial View)</h3>
                        <span v-if="arenaState.status === 'ROUND_1'" class="ml-2 text-primary font-medium loading-dots">åˆ†æå¸«æ­£åœ¨ç¨ç«‹æ€è€ƒ</span>
                    </div>
                    
                    <div class="grid">
                        <div v-for="item in arenaState.results" :key="item.analystId" class="col-12 md:col">
                            <div class="monitor-card flex flex-column">
                                <div class="flex align-items-center border-bottom-1 border-gray-800 pb-2 mb-2">
                                    <span class="mr-2 text-2xl">{{ getAnalystById(item.analystId)?.avatar || 'ğŸ¤–' }}</span>
                                    <span class="font-bold text-lg">{{ getAnalystById(item.analystId)?.name }}</span>
                                    <span v-if="arenaState.status === 'ROUND_1' && !item.round1Done" class="ml-auto text-xs text-yellow-400 bg-yellow-900 px-2 py-1 border-round">
                                        {{ streamingStates[item.analystId] || 'â³ ç­‰å¾…ä¸­' }}
                                    </span>
                                    <span v-else-if="item.round1Done" class="ml-auto text-xs text-green-400">âœ… å®Œæˆ</span>
                                </div>
                                <div class="stream-content text-sm flex-grow-1" v-html="renderMarkdown(item.round1Content)"></div>
                                <div v-if="arenaState.status === 'ROUND_1' && !item.round1Done" class="text-center py-2 text-gray-500">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Round 2: Reference Views -->
                <div v-if="arenaState.status === 'ROUND_2' || arenaState.status === 'CONCLUSION' || arenaState.status === 'DONE'" class="w-full fadein animation-duration-500">
                    <div class="flex align-items-center mb-3 mt-4">
                        <div class="bg-purple-600 text-white w-2rem h-2rem border-circle flex align-items-center justify-content-center font-bold mr-2">2</div>
                        <h3 class="m-0 text-xl">ç¬¬äºŒè¼ªï¼šåƒè€ƒè§€é» (Reference View)</h3>
                        <span v-if="arenaState.status === 'ROUND_2'" class="ml-2 text-purple-500 font-medium loading-dots">åˆ†æå¸«æ­£åœ¨äº¤äº’åƒè€ƒå…¶ä»–è§€é»</span>
                    </div>
                    <!-- Round 2 results grid -->
                    <div class="grid">
                        <div v-for="item in arenaState.results" :key="item.analystId" class="col-12 md:col">
                            <div class="surface-card p-4 shadow-2 border-round h-full border-top-3 border-purple-500 response-card">
                                <div class="flex align-items-center mb-2">
                                    <span class="mr-2 text-2xl">{{ getAnalystById(item.analystId)?.avatar || 'ğŸ¤–' }}</span>
                                    <span class="font-bold text-700">{{ getAnalystById(item.analystId)?.name }}</span>
                                    <span v-if="arenaState.status === 'ROUND_2' && !item.round2Done" class="ml-auto text-xs text-purple-600 bg-purple-100 px-2 py-1 border-round">
                                        {{ streamingStates[item.analystId] || 'â³ ç­‰å¾…ä¸­' }}
                                    </span>
                                    <span v-else-if="item.round2Done" class="ml-auto text-xs text-green-600">âœ… åƒè€ƒå®Œæˆ</span>
                                    <small v-else class="ml-auto text-500">åƒè€ƒäº†å…¶ä»–äººçš„è§€é»...</small>
                                </div>
                                <div class="text-700 line-height-3 stream-content" v-html="renderMarkdown(item.round2Content)"></div>
                                <div v-if="arenaState.status === 'ROUND_2' && !item.round2Done" class="text-center py-2 text-purple-300">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conclusion -->
                <div v-if="arenaState.status === 'CONCLUSION' || arenaState.status === 'DONE'" class="w-full mb-6 fadein animation-duration-500">
                    <div class="flex align-items-center mb-3 mt-4">
                        <div class="bg-green-600 text-white w-2rem h-2rem border-circle flex align-items-center justify-content-center font-bold mr-2"><i class="fa-solid fa-gavel"></i></div>
                        <h3 class="m-0 text-xl">æœ€çµ‚çµè«– (Verdict)</h3>
                        <span v-if="arenaState.status === 'CONCLUSION'" class="ml-2 text-green-600 font-medium">
                            {{ conclusionState || 'AI è£åˆ¤æ­£åœ¨è™•ç†' }}
                            <span class="loading-dots"></span>
                        </span>
                    </div>

                    <div class="surface-card p-5 shadow-4 border-round border-left-3 border-green-500">
                         <div class="text-900 text-lg stream-content line-height-3" v-html="renderMarkdown(arenaState.conclusionContent)"></div>
                         <div v-if="arenaState.status === 'CONCLUSION'" class="text-center py-2 text-green-500">
                             <i class="fa-solid fa-circle-notch fa-spin"></i>
                         </div>
                    </div>

                    <!-- Report Section -->
                    <div v-if="arenaState.status === 'DONE'" class="mt-4 fadein animation-duration-500">
                        <div class="flex justify-content-center gap-3 mb-4">
                             <button @click="generateAIReport" :disabled="isGeneratingReport" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);" class="p-3 px-5 text-white border-none border-round cursor-pointer shadow-3 hover:shadow-5 font-bold transition-all text-lg disabled:opacity-50">
                                 <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>{{ isGeneratingReport ? 'AI å ±å‘Šç”Ÿæˆä¸­...' : 'ç”Ÿæˆ AI å ±å‘Š' }}
                             </button>
                             <button v-if="arenaState.reportContent" @click="exportCurrentPDF" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);" class="p-3 px-5 text-white border-none border-round cursor-pointer shadow-3 hover:shadow-5 font-bold transition-all text-lg">
                                 <i class="fa-solid fa-file-pdf mr-2"></i>åŒ¯å‡º PDF å ±å‘Š
                             </button>
                        </div>

                        <div v-if="arenaState.reportContent" class="surface-card p-5 shadow-4 border-round border-top-3 border-blue-500 bg-blue-50" id="arena-report-content">
                            <h2 class="text-2xl font-bold mb-4 text-blue-900 border-bottom-1 border-blue-100 pb-3">
                                <i class="fa-solid fa-file-contract mr-2"></i>ç«¶æŠ€ç¸½çµå ±å‘Š
                            </h2>
                            <div class="text-900 line-height-4 stream-content text-lg" v-html="renderMarkdown(arenaState.reportContent)"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- View: History -->
        <div v-if="currentView === 'HISTORY'" class="max-w-70rem mx-auto fadein animation-duration-300">
            <div class="flex justify-content-between align-items-center mb-4">
                <h2 class="text-2xl font-bold m-0"><i class="fa-solid fa-history mr-2 text-primary"></i>æ­·å²åˆ†æçµæœ</h2>
                <div class="p-inputgroup w-20rem">
                    <span class="p-inputgroup-addon bg-white border-right-none p-2 border-1 border-300 border-round-left"><i class="fa-solid fa-search text-400"></i></span>
                    <input v-model="historySearchQuery" type="text" class="p-2 border-1 border-300 border-round-right w-full outline-none" placeholder="æœå°‹ä¸»é¡Œ...">
                </div>
            </div>

            <div v-if="filteredHistory.length === 0" class="surface-card p-6 border-round shadow-1 text-center">
                <i class="fa-solid fa-folder-open text-6xl text-300 mb-3"></i>
                <p class="text-xl text-500">å°šç„¡ç›¸é—œæ­·å²ç´€éŒ„ã€‚</p>
            </div>

            <div class="grid">
                <div v-for="item in filteredHistory" :key="item.id" class="col-12 md:col-6 lg:col-4">
                    <div @click="viewHistoryDetail(item)" class="surface-card p-4 shadow-2 border-round h-full cursor-pointer hover:shadow-4 transition-all border-top-3 border-primary flex flex-column">
                        <div class="text-xs text-500 mb-2 flex justify-content-between">
                            <span><i class="fa-regular fa-calendar-alt mr-1"></i>{{ formatDate(item.timestamp) }}</span>
                            <span class="bg-blue-50 text-blue-600 px-2 py-1 border-round">{{ item.results.length }} ä½åˆ†æå¸«</span>
                        </div>
                        <h3 class="m-0 text-xl text-900 mb-3 line-height-3">{{ item.theme }}</h3>
                        <div class="text-600 text-sm mb-4 line-height-3 flex-grow-1 overflow-hidden" style="max-height: 4.5rem;">
                            {{ (item.conclusionContent || '').substring(0, 100) }}...
                        </div>
                        <div class="flex justify-content-end gap-2">
                             <button @click.stop="deleteHistory(item.id)" class="p-2 text-400 hover:text-red-500 border-none bg-transparent cursor-pointer">
                                 <i class="fa-solid fa-trash-alt"></i>
                             </button>
                             <button class="bg-primary-50 text-primary border-none px-3 py-2 border-round font-medium hover:bg-primary-100 transition-colors">
                                 æŸ¥çœ‹ç´°ç¯€
                             </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Detail Modal -->
        <div v-if="selectedHistoryItem" class="fixed top-0 left-0 w-full h-full bg-black-alpha-50 flex align-items-center justify-content-center z-5 p-4">
            <div style="background-color: #ffffff !important;" class="shadow-8 border-round w-full max-w-70rem h-full flex flex-column relative">
                <div class="p-4 border-bottom-1 surface-border flex justify-content-between align-items-center">
                    <div>
                        <span class="text-500 text-sm">æ­·å²ç´€éŒ„ - {{ formatDate(selectedHistoryItem.timestamp) }}</span>
                        <h2 class="m-0 text-xl font-bold">{{ selectedHistoryItem.theme }}</h2>
                    </div>
                    <div class="flex gap-2">
                        <button v-if="selectedHistoryItem.reportContent" @click="exportHistoryReportPDF" class="p-2 px-3 bg-blue-600 text-white border-none border-round cursor-pointer hover:bg-blue-700 font-medium">
                            <i class="fa-solid fa-file-contract mr-2"></i>åŒ¯å‡ºå ±å‘Š PDF
                        </button>
                        <button @click="exportHistoryPDF" class="p-2 px-3 bg-red-500 text-white border-none border-round cursor-pointer hover:bg-red-600 font-medium">
                            <i class="fa-solid fa-file-pdf mr-2"></i>åŒ¯å‡ºå®Œæ•´ç´€éŒ„
                        </button>
                        <button @click="selectedHistoryItem = null" class="p-2 px-3 surface-100 text-700 border-none border-round cursor-pointer hover:surface-200 font-medium">
                            <i class="fa-solid fa-times mr-2"></i>é—œé–‰
                        </button>
                    </div>
                </div>
                <div class="flex-grow-1 overflow-y-auto p-4 bg-gray-50" id="history-pdf-content">
                    <div v-if="selectedHistoryItem.reportContent" class="mb-4 surface-card p-5 shadow-2 border-round border-top-3 border-blue-500" id="history-report-only">
                        <h3 class="text-xl font-bold mb-3 text-blue-900 border-bottom-1 border-blue-100 pb-2">
                             <i class="fa-solid fa-file-contract mr-2"></i>ç«¶æŠ€ç¸½çµå ±å‘Š
                        </h3>
                        <div class="text-900 line-height-4 stream-content text-lg" v-html="renderMarkdown(selectedHistoryItem.reportContent)"></div>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-lg font-bold mb-3 border-left-3 border-blue-500 pl-2">ç¬¬ä¸€è¼ªï¼šç¨ç«‹è§€é»</h3>
                        <div class="grid">
                            <div v-for="res in selectedHistoryItem.results" :key="res.analystId" class="col-12 md:col">
                                <div class="monitor-card h-auto">
                                    <div class="flex align-items-center border-bottom-1 border-gray-800 pb-2 mb-2">
                                        <span class="mr-2 text-2xl font-bold">{{ res.analystName }}</span>
                                    </div>
                                    <div class="stream-content text-sm" v-html="renderMarkdown(res.round1Content)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h3 class="text-lg font-bold mb-3 border-left-3 border-purple-500 pl-2">ç¬¬äºŒè¼ªï¼šåƒè€ƒè§€é»</h3>
                        <div class="grid">
                            <div v-for="res in selectedHistoryItem.results" :key="res.analystId" class="col-12 md:col">
                                <div class="surface-card p-4 shadow-1 border-round h-full border-top-3 border-purple-500">
                                    <div class="font-bold text-700 mb-2">{{ res.analystName }}</div>
                                    <div class="stream-content text-sm" v-html="renderMarkdown(res.round2Content)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 border-left-3 border-green-500 pl-2">æœ€çµ‚çµè«–</h3>
                        <div class="surface-card p-4 shadow-1 border-round border-left-3 border-green-500 stream-content" v-html="renderMarkdown(selectedHistoryItem.conclusionContent)"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <div class="surface-0 p-3 flex justify-content-center align-items-center border-top-1 surface-border ml-2 mr-2 mb-2 border-round shadow-1">
        <a href="https://github.com/joypan/stockAreana" target="_blank" class="text-700 no-underline hover:text-primary mr-3 flex align-items-center transition-colors">
            <i class="fa-brands fa-github text-xl mr-2"></i>
            <span class="font-medium">joypan/stockAreana</span>
        </a>
        <span class="text-400 mr-3">|</span>
        <span class="text-500 text-sm">MIT License</span>
    </div>

    <!-- Modals -->
    <!-- Settings Modal -->
    <div v-if="showSettings" class="fixed top-0 left-0 w-full h-full bg-black-alpha-50 flex align-items-center justify-content-center z-5">
        <div style="background-color: #ffffff !important;" class="p-5 shadow-8 border-round w-full max-w-30rem">
            <h3 class="m-0 mb-4 text-xl font-bold">ç³»çµ±è¨­å®š</h3>
            <div class="field mb-4">
                <label class="block text-900 font-medium mb-2">OpenAI API Key</label>
                <div class="p-inputgroup flex">
                    <span class="p-inputgroup-addon bg-surface-100 border-1 border-300 border-right-none p-2 border-round-left flex align-items-center"><i class="fa-solid fa-key text-600"></i></span>
                    <input v-model="apiKey" type="password" class="w-full p-2 border-1 border-300 border-round-right" placeholder="sk-...">
                </div>
                <small class="block mt-2 text-500">æˆ‘å€‘æœƒå°‡ Key å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ LocalStorage ä¸­ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</small>
            </div>
            <div class="flex justify-content-end">
                <button @click="saveSettings" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" class="text-white border-none px-4 py-2 border-round cursor-pointer font-bold shadow-2">å„²å­˜ä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Analyst Modal -->
    <div v-if="showAnalystModal" class="fixed top-0 left-0 w-full h-full bg-black-alpha-50 flex align-items-center justify-content-center z-5">
        <div style="background-color: #ffffff !important;" class="p-5 shadow-8 border-round w-full max-w-40rem relative">
            <button @click="showAnalystModal = false" class="absolute top-0 right-0 m-3 p-2 bg-transparent border-none cursor-pointer text-500 hover:text-900 text-xl">
                <i class="fa-solid fa-times"></i>
            </button>
            
            <h3 class="m-0 mb-4 text-xl font-bold">{{ editingAnalyst.id ? 'ç·¨è¼¯åˆ†æå¸«' : 'æ–°å¢åˆ†æå¸«' }}</h3>
            
            <div class="field mb-3">
                <label class="block text-900 font-medium mb-2">åç¨± (Name)</label>
                <input v-model="editingAnalyst.name" type="text" class="w-full p-2 border-1 border-300 border-round" placeholder="e.g. å·´è²ç‰¹é¢¨æ ¼ AI">
            </div>

             <div class="field mb-3">
                <label class="block text-900 font-medium mb-2">ä»£è¡¨åœ–ç¤º (Avatar Emoji)</label>
                <input v-model="editingAnalyst.avatar" type="text" class="w-full p-2 border-1 border-300 border-round" placeholder="e.g. ğŸ‘´">
            </div>

            <div class="field mb-3">
                <label class="block text-900 font-medium mb-2">æ¨¡å‹ (Model)</label>
                <select v-model="editingAnalyst.model" class="w-full p-2 border-1 border-300 border-round bg-white">
                    <option v-for="model in availableModels" :key="model" :value="model">{{ model }}</option>
                </select>
            </div>

            <div class="field mb-4">
                <label class="block text-900 font-medium mb-2">ç³»çµ±æç¤ºè© (System Prompt)</label>
                <textarea v-model="editingAnalyst.systemPrompt" rows="5" class="w-full p-2 border-1 border-300 border-round line-height-3" placeholder="ä½ æ˜¯ä¸€ä½..."></textarea>
                <small class="text-500">å®šç¾©é€™ä½åˆ†æå¸«çš„äººè¨­ã€åˆ†æé¢¨æ ¼èˆ‡åˆ‡å…¥è§’åº¦ã€‚</small>
            </div>

            <div class="flex justify-content-end">
                <button @click="saveAnalyst" class="bg-primary  border-none px-4 py-2 border-round cursor-pointer font-bold shadow-2">
                    <i class="fa-solid fa-save mr-2"></i>å„²å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="showDeleteModal" class="fixed top-0 left-0 w-full h-full bg-black-alpha-50 flex align-items-center justify-content-center z-5">
        <div style="background-color: #ffffff !important;" class="p-5 shadow-8 border-round w-full max-w-25rem relative text-center">
            <div class="mb-4 text-orange-500 text-6xl">
                <i class="fa-solid fa-circle-exclamation"></i>
            </div>
            <h3 class="m-0 mb-3 text-2xl font-bold text-900">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p class="text-600 mb-5 line-height-3">åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè©²åˆ†æå¸«å°‡å¾æ‚¨çš„åœ˜éšŠä¸­æ°¸ä¹…ç§»é™¤ã€‚</p>
            
            <div class="flex justify-content-center gap-3">
                <button @click="showDeleteModal = false" class="px-4 py-2 border-1 border-300 surface-100 text-700 border-round cursor-pointer hover:bg-surface-200 font-bold transition-colors">
                    å–æ¶ˆ
                </button>
                <button @click="confirmDeleteAnalyst" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);" class="px-4 py-2 border-none text-white border-round cursor-pointer font-bold shadow-2 hover:shadow-4 transition-all">
                    <i class="fa-solid fa-trash-alt mr-2"></i>ç¢ºèªåˆªé™¤
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    // --- IndexedDB Service ---
    const DB_NAME = 'StockArenaDB';
    const DB_VERSION = 3;
    const STORE_ANALYSTS = 'analysts';
    const STORE_THEMES = 'themes';
    const STORE_HISTORY = 'history';

    const dbService = {
        db: null,
        async open() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION + 1); // Incremented to add history
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_ANALYSTS)) {
                        db.createObjectStore(STORE_ANALYSTS, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_THEMES)) {
                        db.createObjectStore(STORE_THEMES, { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains(STORE_HISTORY)) {
                        db.createObjectStore(STORE_HISTORY, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve(this.db);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        },
        async getAll(storeName) {
            if (!this.db) await this.open();
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        },
        async save(storeName, item) {
            if (!this.db) await this.open();
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                // remove id if it's null/undefined so autoIncrement works
                const data = { ...item };
                if (!data.id) delete data.id;
                
                const request = store.put(data);
                let resultKey = null;
                request.onsuccess = (e) => { resultKey = e.target.result; };
                
                tx.oncomplete = () => resolve(resultKey);
                tx.onerror = () => reject(tx.error);
            });
        },
        async delete(storeName, id) {
            if (!this.db) await this.open();
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.delete(id);
                tx.oncomplete = () => {
                    console.log(`[dbService] Delete transaction completed for id: ${id}`);
                    resolve();
                };
                tx.onerror = () => reject(tx.error);
            });
        }
    };

    // --- Vue App ---
    createApp({
        setup() {
            // State
            const apiKey = ref(localStorage.getItem('openai_key') || '');
            const showSettings = ref(false);
            const currentView = ref('HOME'); // Start at home, or Analyst list if empty
            const availableModels = ref(['gpt-4o', 'gpt-4o-mini', 'gpt-3.5-turbo']); // é è¨­æ¨¡å‹ï¼Œæœƒè¢« API çµæœè¦†è“‹
            
            // Analyst Management
            const analysts = ref([]);
            const showAnalystModal = ref(false);
            const editingAnalyst = ref({ id: null, name: '', avatar: '', model: 'gpt-4o', systemPrompt: '' });
            
            // Delete Dialog State
            const showDeleteModal = ref(false);
            const analystToDeleteId = ref(null);

            // Theme Management
            const savedThemes = ref([]);
            const selectedThemeId = ref(null);

            // Arena State
            const arenaState = reactive({
                status: 'IDLE', // IDLE, ROUND_1, ROUND_2, CONCLUSION, DONE
                theme: '',
                selectedAnalystIds: [],
                selectedModels: {}, // æ–°å¢ï¼šå­˜å„²æœ¬æ¬¡ç«¶æŠ€æ¯å€‹åˆ†æå¸«é¸æ“‡çš„æ¨¡å‹
                judgeModel: 'gpt-4o',
                currentHistoryId: null, // Track current history ID
                results: [], // { analystId, round1Content, round1Done, round2Content, round2Done }
                conclusionContent: '',
                reportContent: '' // æ–°å¢ï¼šå„²å­˜ AI ç”Ÿæˆçš„å ±å‘Šå…§å®¹
            });
            
            // History State
            const historyList = ref([]);
            const historySearchQuery = ref('');
            const selectedHistoryItem = ref(null);
            const isGeneratingReport = ref(false);

            const filteredHistory = computed(() => {
                if (!historySearchQuery.value) return historyList.value;
                const q = historySearchQuery.value.toLowerCase();
                return historyList.value.filter(h => h.theme.toLowerCase().includes(q));
            });
            
            // å³æ™‚ç‹€æ…‹è¿½è¹¤ (ç¨ç«‹ ref ç¢ºä¿éŸ¿æ‡‰å¼)
            const streamingStates = ref({});
            const conclusionState = ref('');

            // --- Lifecycle ---
            onMounted(async () => {
                await dbService.open();
                await Promise.all([loadAnalysts(), loadThemes(), loadHistory()]);
                
                // å˜—è©¦å–å¾—æ¨¡å‹åˆ—è¡¨
                await fetchModels();
                
                if (!apiKey.value) showSettings.value = true;
                
                // If we have analysts, default to Arena view, else Analysts view
                if (analysts.value.length > 0) currentView.value = 'ARENA';
                else currentView.value = 'ANALYSTS';
            });

            // --- Methods: Management ---
            const loadHistory = async () => {
                const res = await dbService.getAll(STORE_HISTORY);
                // Sort by timestamp desc
                historyList.value = res.sort((a, b) => b.timestamp - a.timestamp);
            };
            const loadAnalysts = async () => {
                const res = await dbService.getAll(STORE_ANALYSTS);
                console.log('[loadAnalysts] Loaded items:', res.length, res);
                analysts.value = res;
            };
            
            const loadThemes = async () => {
                savedThemes.value = await dbService.getAll(STORE_THEMES);
            };
            
            // å¾ OpenAI API å–å¾—æ¨¡å‹åˆ—è¡¨
            const fetchModels = async () => {
                if (!apiKey.value) return; // æ²’æœ‰ API Key å‰‡è·³é
                
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey.value}`
                        }
                    });

                    if (!response.ok) {
                        console.warn('Failed to fetch models:', response.status);
                        return;
                    }

                    const data = await response.json();
                    
                    // éæ¿¾ GPT æ¨¡å‹ï¼ˆgpt-4ã€gpt-5 ä»¥ä¸Šï¼‰
                    const gptModels = data.data
                        .filter(m => {
                            const id = m.id.toLowerCase();
                            // åŒ…å« gpt-4ã€gpt-5 ä»¥ä¸Šçš„æ¨¡å‹ï¼Œæ’é™¤ instructã€realtimeã€audio ç­‰ç‰¹æ®Šç‰ˆæœ¬
                            return (id.includes('gpt-4') || id.includes('gpt-5')) && 
                                   !id.includes('instruct') && 
                                   !id.includes('realtime') && 
                                   !id.includes('audio');
                        })
                        .map(m => m.id)
                        .sort((a, b) => {
                            // æ’åºï¼šgpt-5 å„ªå…ˆï¼Œç„¶å¾Œ gpt-4oï¼Œæœ€å¾Œ gpt-4
                            const priority = (id) => {
                                if (id.includes('gpt-5')) return 0;
                                if (id.includes('gpt-4o')) return 1;
                                if (id.includes('gpt-4-turbo')) return 2;
                                return 3;
                            };
                            return priority(a) - priority(b) || a.localeCompare(b);
                        });
                    
                    if (gptModels.length > 0) {
                        availableModels.value = gptModels;
                        console.log('Loaded models from API:', gptModels);
                    }
                } catch (e) {
                    console.error('Error fetching models:', e);
                }
            };

            const saveSettings = () => {
                localStorage.setItem('openai_key', apiKey.value);
                showSettings.value = false;
                // å„²å­˜å¾Œé‡æ–°å–å¾—æ¨¡å‹åˆ—è¡¨
                fetchModels();
            };

            const openAnalystModal = (analyst = null) => {
                if (analyst) {
                    editingAnalyst.value = { ...analyst };
                } else {
                    editingAnalyst.value = { id: null, name: '', avatar: '', model: 'gpt-4o', systemPrompt: '' };
                }
                showAnalystModal.value = true;
            };

            const saveAnalyst = async () => {
                if (!editingAnalyst.value.name || !editingAnalyst.value.systemPrompt) {
                    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                    return;
                }
                await dbService.save(STORE_ANALYSTS, editingAnalyst.value);
                await loadAnalysts();
                showAnalystModal.value = false;
            };

            const deleteAnalyst = (id) => {
                analystToDeleteId.value = id;
                showDeleteModal.value = true;
            };

            const confirmDeleteAnalyst = async () => {
                if (!analystToDeleteId.value) return;
                
                try {
                    await dbService.delete(STORE_ANALYSTS, analystToDeleteId.value);
                    console.log('Deleted successfully mid:', analystToDeleteId.value);
                    await loadAnalysts();
                    showDeleteModal.value = false;
                    analystToDeleteId.value = null;
                } catch (e) {
                     console.error('Delete error:', e);
                     alert('åˆªé™¤å¤±æ•—ï¼Œè«‹çœ‹ Console Log');
                }
            };
            
            const saveCurrentTheme = async () => {
                if(!arenaState.theme) return;
                // Check if already exists?
                const exists = savedThemes.value.find(t => t.content === arenaState.theme);
                if(exists) return;
                
                await dbService.save(STORE_THEMES, { content: arenaState.theme });
                await loadThemes();
                alert('ä¸»é¡Œå·²å„²å­˜');
            };
            
            const deleteTheme = async (e, id) => {
                e.stopPropagation(); // prevent select change
                if(confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ä¸»é¡Œç´€éŒ„ï¼Ÿ')) {
                    await dbService.delete(STORE_THEMES, id);
                    await loadThemes();
                    if(selectedThemeId.value === id) {
                        selectedThemeId.value = null;
                        arenaState.theme = '';
                    }
                }
            }

            // --- Methods: Arena ---
            const toggleAnalystSelection = (id) => {
                debugger;
                if (arenaState.selectedAnalystIds.includes(id)) {
                    arenaState.selectedAnalystIds = arenaState.selectedAnalystIds.filter(x => x !== id);
                    delete arenaState.selectedModels[id];
                } else {
                    if (arenaState.selectedAnalystIds.length >= 3) {
                        alert('æœ€å¤šé¸æ“‡ 3 ä½åˆ†æå¸«');
                        return;
                    }
                    arenaState.selectedAnalystIds.push(id);
                    // é è¨­ä½¿ç”¨åˆ†æå¸«è¨­å®šçš„æ¨¡å‹
                    arenaState.selectedModels[id] = getAnalystById(id).model;
                }
            };
            
            watch(selectedThemeId, (newId) => {
                if(newId) {
                    const t = savedThemes.value.find(x => x.id === newId);
                    if(t) arenaState.theme = t.content;
                } else {
                    // reset? No, keep text if user wants to type
                }
            });

            const canStartArena = computed(() => {
                return arenaState.theme && arenaState.selectedAnalystIds.length > 0 && apiKey.value;
            });

            const getAnalystById = (id) => analysts.value.find(a => a.id === id);

            const resetArena = () => {
                arenaState.status = 'IDLE';
                arenaState.currentHistoryId = null; // Reset history ID
                arenaState.results = [];
                arenaState.conclusionContent = '';
                arenaState.reportContent = '';
                streamingStates.value = {};
                conclusionState.value = '';
            };

            const renderMarkdown = (text) => {
                return marked.parse(text || '');
            };

            // --- Core Logic: LLM Integration ---
            // äº‹ä»¶é¡å‹å°æ‡‰çš„ä¸­æ–‡ç‹€æ…‹æè¿°
            const eventStatusMap = {
                'response.created': 'ğŸš€ é€£ç·šå»ºç«‹',
                'response.in_progress': 'â³ è™•ç†ä¸­',
                'response.output_item.added': 'ğŸ“ æº–å‚™è¼¸å‡º',
                'response.content_part.added': 'âœï¸ é–‹å§‹ç”Ÿæˆ',
                'response.output_text.delta': 'ğŸ’¬ ç”Ÿæˆå…§å®¹ä¸­',
                'response.web_search_call.in_progress': 'ğŸ” ç¶²é æœå°‹ä¸­',
                'response.web_search_call.searching': 'ğŸŒ æ­£åœ¨æœå°‹ç¶²é ',
                'response.web_search_call.completed': 'âœ… æœå°‹å®Œæˆ',
                'response.completed': 'âœ… å®Œæˆ'
            };

            const streamCompletion = async (messages, model, onChunk, onStatusChange = null) => {
                try {
                    // é€šçŸ¥é–‹å§‹
                    if (onStatusChange) onStatusChange('ğŸš€ é€£ç·šå»ºç«‹');

                    const response = await fetch('https://api.openai.com/v1/responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey.value}`
                    },
                    body: JSON.stringify({
                        model,
                        input: messages,
                        stream: true,
                        tools: [
                        {
                            type: "web_search",
                            user_location: { type: "approximate" },
                            search_context_size: "medium"
                        }
                        ]
                    })
                    });

                    if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API Error');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const events = buffer.split('\n\n');
                    buffer = events.pop(); // ä¿ç•™ä¸å®Œæ•´ event

                    for (const event of events) {
                        const lines = event.split('\n');
                        let eventType = '';
                        let dataLine = '';

                        for (const line of lines) {
                        if (line.startsWith('event:')) {
                            eventType = line.slice(6).trim();
                        } else if (line.startsWith('data:')) {
                            dataLine = line.slice(5).trim();
                        }
                        }

                        // æ›´æ–°ç‹€æ…‹å›èª¿
                        if (onStatusChange && eventStatusMap[eventType]) {
                            onStatusChange(eventStatusMap[eventType]);
                        }

                        // âœ… æ­£ç¢ºçš„æ–‡å­— stream äº‹ä»¶
                        if (eventType === 'response.output_text.delta') {
                        const json = JSON.parse(dataLine);
                        if (json.delta) onChunk(json.delta);
                        }

                        // çµæŸ
                        if (eventType === 'response.completed') {
                        if (onStatusChange) onStatusChange('âœ… å®Œæˆ');
                        return;
                        }
                    }
                    }
                } catch (e) {
                    onChunk(`\n[ERROR: ${e.message}]`);
                    if (onStatusChange) onStatusChange('âŒ éŒ¯èª¤');
                    console.error(e);
                }
            };

            const startArena = async () => {
                if (!canStartArena.value) return;
                
                // Auto-save theme? Let's just user specific Save button
                
                // Init State
                arenaState.status = 'ROUND_1';
                arenaState.currentHistoryId = null; // New round, new history
                streamingStates.value = {}; // æ¸…ç©ºç‹€æ…‹
                conclusionState.value = '';
                arenaState.conclusionContent = '';
                arenaState.reportContent = '';
                arenaState.results = arenaState.selectedAnalystIds.map(id => ({
                    analystId: id,
                    round1Content: '',
                    round1Done: false,
                    round2Content: '',
                    round2Done: false
                }));
                
                // åˆå§‹åŒ–æ¯å€‹åˆ†æå¸«çš„ç‹€æ…‹
                arenaState.selectedAnalystIds.forEach(id => {
                    streamingStates.value[id] = 'â³ ç­‰å¾…ä¸­';
                });

                // Execute Round 1 in Parallel
                const r1Promises = arenaState.results.map(async (resultItem) => {
                    const analyst = getAnalystById(resultItem.analystId);
                    const modelToUse = arenaState.selectedModels[resultItem.analystId] || analyst.model;
                    const messages = [
                        { role: 'system', content: analyst.systemPrompt },
                        { role: 'user', content: `åˆ†æä¸»é¡Œï¼š${arenaState.theme}\nè«‹ç™¼è¡¨ä½ çš„å°ˆæ¥­çœ‹æ³•ã€‚` }
                    ];

                    await streamCompletion(
                        messages, 
                        modelToUse, 
                        (chunk) => {
                            resultItem.round1Content += chunk;
                        },
                        (status) => {
                            streamingStates.value[resultItem.analystId] = status;
                        }
                    );
                    resultItem.round1Done = true;
                    streamingStates.value[resultItem.analystId] = 'âœ… å®Œæˆ';
                });

                await Promise.all(r1Promises);

                // Start Round 2
                arenaState.status = 'ROUND_2';
                
                // é‡ç½®ç‹€æ…‹
                arenaState.selectedAnalystIds.forEach(id => {
                    streamingStates.value[id] = 'â³ ç­‰å¾…ä¸­';
                });
                
                // Prepare context for each analyst (what others said)
                const r2Promises = arenaState.results.map(async (resultItem) => {
                    const analyst = getAnalystById(resultItem.analystId);
                    const modelToUse = arenaState.selectedModels[resultItem.analystId] || analyst.model;
                    
                    // Build other's opinions string
                    let othersOpinions = '';
                    arenaState.results.forEach(r => {
                        if (r.analystId !== resultItem.analystId) {
                            const otherName = getAnalystById(r.analystId).name;
                            othersOpinions += `\n--- åˆ†æå¸« ${otherName} çš„è§€é» ---\n${r.round1Content}\n`;
                        }
                    });

                    const messages = [
                        { role: 'system', content: analyst.systemPrompt },
                        { role: 'user', content: `åˆ†æä¸»é¡Œï¼š${arenaState.theme}\né€™æ˜¯æˆ‘ä¹‹å‰çš„çœ‹æ³•ï¼š${resultItem.round1Content}` },
                        { role: 'user', content: `ç¾åœ¨è«‹åƒè€ƒå…¶ä»–åˆ†æå¸«çš„è§€é»ï¼š\n${othersOpinions}\n\nè«‹ç¶œåˆåƒè€ƒé€™äº›æ„è¦‹ï¼Œå†æ¬¡ç™¼è¡¨ä½ çš„çœ‹æ³•ï¼ˆå¯ä»¥æ˜¯è£œå……ã€ä¿®æ­£æˆ–ç¶­æŒåŸåˆ¤ï¼Œé‡é»æ˜¯åƒè€ƒä»–äººè§€é»å¾Œçš„æœ€ä½³åˆ¤æ–·ï¼‰ã€‚` }
                    ];

                    await streamCompletion(
                        messages, 
                        modelToUse, 
                        (chunk) => {
                            resultItem.round2Content += chunk;
                        },
                        (status) => {
                            streamingStates.value[resultItem.analystId] = status;
                        }
                    );
                    resultItem.round2Done = true;
                    streamingStates.value[resultItem.analystId] = 'âœ… å®Œæˆ';
                });

                await Promise.all(r2Promises);

                // Start Conclusion
                arenaState.status = 'CONCLUSION';
                conclusionState.value = 'â³ ç­‰å¾…ä¸­';
                
                let allDiscussions = `ä¸»é¡Œï¼š${arenaState.theme}\n\n`;
                arenaState.results.forEach(r => {
                    const name = getAnalystById(r.analystId).name;
                    allDiscussions += `### åˆ†æå¸« ${name} ç¬¬ä¸€è¼ªè§€é»\n${r.round1Content}\n\n`;
                    allDiscussions += `### åˆ†æå¸« ${name} ç¬¬äºŒè¼ª(åƒè€ƒå¾Œ)è§€é»\n${r.round2Content}\n\n`;
                });

                const judgeMessages = [
                    { role: 'system', content: 'ä½ æ˜¯ä¸€ä½å…¬æ­£çš„è‚¡å¸‚è£åˆ¤èˆ‡ç¸½çµè€…ã€‚ä½ çš„ä»»å‹™æ˜¯é–±è®€å¤šä½åˆ†æå¸«é‡å°åŒä¸€ä¸»é¡Œçš„äº¤äº’è¨è«–ï¼Œæœ€å¾Œçµ¦å‡ºä¸€å€‹ç¶œåˆæ€§çš„çµè«–èˆ‡æŠ•è³‡å»ºè­°ã€‚è«‹å®¢è§€è©•ä¼°å„æ–¹è«–é»çš„å¼·å¼±ã€‚' },
                    { role: 'user', content: `è«‹æ ¹æ“šä»¥ä¸‹è¨è«–å…§å®¹é€²è¡Œç¸½çµï¼š\n\n${allDiscussions}` }
                ];

                await streamCompletion(
                    judgeMessages, 
                    arenaState.judgeModel, 
                    (chunk) => {
                        arenaState.conclusionContent += chunk;
                    },
                    (status) => {
                        conclusionState.value = status;
                    }
                );

                conclusionState.value = 'âœ… å®Œæˆ';
                arenaState.status = 'DONE';
                
                // è‡ªå‹•å„²å­˜åˆ°æ­·å²ç´€éŒ„
                await saveHistory();
            };

            const saveHistory = async () => {
                const historyItem = {
                    ...(arenaState.currentHistoryId ? { id: arenaState.currentHistoryId } : {}), // Update existing if ID exists
                    theme: arenaState.theme,
                    timestamp: Date.now(),
                    results: arenaState.results.map(r => ({
                        ...r,
                        analystName: getAnalystById(r.analystId).name
                    })),
                    conclusionContent: arenaState.conclusionContent,
                    reportContent: arenaState.reportContent, // Save generated report
                    judgeModel: arenaState.judgeModel
                };
                const id = await dbService.save(STORE_HISTORY, historyItem);
                if (!arenaState.currentHistoryId) {
                    arenaState.currentHistoryId = id; // Set ID after first save
                }
                await loadHistory();
            };

            const generateAIReport = async () => {
                if (isGeneratingReport.value) return;
                isGeneratingReport.value = true;
                arenaState.reportContent = '';

                let fullTranscript = `ä¸»é¡Œï¼š${arenaState.theme}\n\n`;
                arenaState.results.forEach(r => {
                    const name = getAnalystById(r.analystId).name;
                    fullTranscript += `## åˆ†æå¸« ${name}\n`;
                    fullTranscript += `### ç¬¬ä¸€è¼ªè§€é»ï¼š\n${r.round1Content}\n\n`;
                    fullTranscript += `### ç¬¬äºŒè¼ª(äº¤äº’åƒè€ƒå¾Œ)è§€é»ï¼š\n${r.round2Content}\n\n`;
                });
                fullTranscript += `## AI è£åˆ¤ç¸½çµï¼š\n${arenaState.conclusionContent}\n\n`;

                const messages = [
                    { role: 'system', content: 'ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è­‰åˆ¸åˆ†æå ±å‘Šæ’°å¯«å“¡ã€‚è«‹æ ¹æ“šä»¥ä¸‹å¤šä½åˆ†æå¸«çš„è¨è«–èˆ‡è£åˆ¤ç¸½çµï¼Œæ’°å¯«ä¸€ä»½æ­£å¼ã€è©³ç›¡ä¸”çµæ§‹åŒ–çš„ã€ŒæŠ•è³‡åˆ†æå ±å‘Šã€ã€‚å ±å‘Šæ‡‰åŒ…å«ï¼šä¸»é¡ŒèƒŒæ™¯ã€å„æ–¹è§€é»ç²¾è¦ã€è¡çªé»åˆ†æã€æœ€çµ‚æŠ•è³‡å»ºè­°èˆ‡é¢¨éšªæç¤ºã€‚è«‹ä½¿ç”¨å°ˆæ¥­ä¸”å„ªé›…çš„ Markdown æ ¼å¼ã€‚' },
                    { role: 'user', content: `è«‹æ ¹æ“šä»¥ä¸‹è¨è«–å…§å®¹ç”Ÿæˆæ­£å¼å ±å‘Šï¼š\n\n${fullTranscript}` }
                ];

                try {
                    await streamCompletion(
                        messages, 
                        arenaState.judgeModel, 
                        (chunk) => {
                            arenaState.reportContent += chunk;
                        }
                    );
                    // Generate completed, save to history
                    await saveHistory();
                } finally {
                    isGeneratingReport.value = false;
                }
            };

            const deleteHistory = async (id) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†æ­·å²ç´€éŒ„ï¼Ÿ')) {
                    await dbService.delete(STORE_HISTORY, id);
                    await loadHistory();
                }
            };

            const viewHistoryDetail = (item) => {
                selectedHistoryItem.value = item;
            };

            const formatDate = (ts) => {
                if(!ts) return '';
                const d = new Date(ts);
                return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            };

            const exportCurrentPDF = () => {
                const element = document.getElementById('arena-report-content');
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `Report_${arenaState.theme}_${new Date().getTime()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true, 
                        scrollY: -window.scrollY, 
                        scrollX: -window.scrollX,
                        logging: true,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                html2pdf().set(opt).from(element).save();
            };

            const exportHistoryPDF = () => {
                console.log('[PDF Export] é–‹å§‹åŒ¯å‡º PDF...');
                
                const originalElement = document.getElementById('history-pdf-content');
                if (!originalElement) {
                    console.error('[PDF Export] æ‰¾ä¸åˆ° history-pdf-content å…ƒç´ ');
                    alert('ç„¡æ³•æ‰¾åˆ°è¦åŒ¯å‡ºçš„å…§å®¹');
                    return;
                }
                
                console.log('[PDF Export] æ‰¾åˆ°åŸå§‹å…ƒç´ ');

                // ä¿å­˜åŸå§‹æ¨£å¼
                const originalStyles = new Map();
                const saveAndModifyStyles = (element) => {
                    // è™•ç†é«˜åº¦é™åˆ¶çš„å…ƒç´ 
                    const heightElements = element.querySelectorAll('.monitor-card, .response-card, .overflow-y-auto, .flex-grow-1');
                    heightElements.forEach(el => {
                        originalStyles.set(el, {
                            height: el.style.height,
                            maxHeight: el.style.maxHeight,
                            overflow: el.style.overflow
                        });
                        el.style.height = 'auto';
                        el.style.maxHeight = 'none';
                        el.style.overflow = 'visible';
                    });
                    
                    // å°‡æ‰€æœ‰ grid æ”¹ç‚ºå‚ç›´æ’åˆ—,æ–¹ä¾¿ PDF é–±è®€
                    const grids = element.querySelectorAll('.grid');
                    grids.forEach(grid => {
                        originalStyles.set(grid, {
                            display: grid.style.display,
                            flexDirection: grid.style.flexDirection
                        });
                        grid.style.display = 'flex';
                        grid.style.flexDirection = 'column';
                    });
                    
                    // å°‡ grid å…§çš„åˆ—æ”¹ç‚ºå…¨å¯¬
                    const gridCols = element.querySelectorAll('.grid > div[class*="col-"]');
                    gridCols.forEach(col => {
                        originalStyles.set(col, {
                            width: col.style.width,
                            maxWidth: col.style.maxWidth,
                            marginBottom: col.style.marginBottom
                        });
                        col.style.width = '100%';
                        col.style.maxWidth = '100%';
                        col.style.marginBottom = '1rem'; // å¢åŠ å‚ç›´é–“è·
                    });
                };

                // æ¢å¾©åŸå§‹æ¨£å¼
                const restoreStyles = () => {
                    originalStyles.forEach((styles, el) => {
                        Object.keys(styles).forEach(key => {
                            el.style[key] = styles[key];
                        });
                    });
                    originalStyles.clear();
                };

                // ä¿®æ”¹æ¨£å¼ä¸¦ç”Ÿæˆ PDF
                saveAndModifyStyles(originalElement);
                console.log('[PDF Export] å·²æ“´å±•æ‰€æœ‰å…§å®¹å€åŸŸä¸¦æ”¹ç‚ºå‚ç›´ä½ˆå±€');

                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `History_${selectedHistoryItem.value.theme}_${new Date().getTime()}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true, 
                        allowTaint: true,
                        logging: true,
                        scrollY: -window.scrollY, // è£œå„Ÿç•¶å‰æ»¾å‹•ä½ç½®
                        scrollX: -window.scrollX,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    },
                    pagebreak: { 
                        mode: ['avoid-all', 'css', 'legacy']
                    }
                };

                console.log('[PDF Export] é–‹å§‹ç”Ÿæˆ PDF...');
                
                html2pdf().set(opt).from(originalElement).save()
                    .then(() => {
                        console.log('[PDF Export] PDF ç”ŸæˆæˆåŠŸ');
                        restoreStyles();
                    })
                    .catch(err => {
                        console.error('[PDF Export] åŒ¯å‡ºå¤±æ•—:', err);
                        alert('PDF åŒ¯å‡ºå¤±æ•—: ' + err.message);
                        restoreStyles();
                    });
            };

            const exportHistoryReportPDF = () => {
                const element = document.getElementById('history-report-only');
                const opt = {
                    margin: [10, 10, 10, 10], // Matches history export
                    filename: `Report_History_${selectedHistoryItem.value.theme}_${new Date().getTime()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        allowTaint: true, 
                        scrollY: -window.scrollY,
                        scrollX: -window.scrollX,
                        logging: true,
                        backgroundColor: '#ffffff' 
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                html2pdf().set(opt).from(element).save();
            };


            return {
                apiKey,
                showSettings,
                currentView,
                availableModels,
                analysts,
                savedThemes,
                selectedThemeId,
                showAnalystModal,
                editingAnalyst,
                arenaState,
                // å³æ™‚ç‹€æ…‹ (ç¨ç«‹ ref)
                streamingStates,
                conclusionState,
                
                // History State
                historyList,
                historySearchQuery,
                selectedHistoryItem,
                isGeneratingReport,
                filteredHistory,

                openAnalystModal,
                saveSettings,
                saveAnalyst,
                deleteAnalyst,
                saveCurrentTheme,
                deleteTheme,
                toggleAnalystSelection,
                canStartArena,
                startArena,
                resetArena,
                getAnalystById,
                renderMarkdown,
                // Delete Modal
                showDeleteModal,
                confirmDeleteAnalyst,
                analystToDeleteId,

                // History & PDF Methods
                generateAIReport,
                deleteHistory,
                viewHistoryDetail,
                formatDate,
                exportCurrentPDF,
                exportHistoryPDF,
                exportHistoryReportPDF
            };
        }
    }).mount('#app');
</script>

</body>
</html>
